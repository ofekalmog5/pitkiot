name: Build Pitkiot iOS App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Select Xcode version
      run: sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
    
    - name: Build for iOS Simulator
      run: |
        xcodebuild \
          -project HebrewAlias.xcodeproj \
          -scheme HebrewAlias \
          -configuration Debug \
          -sdk iphonesimulator \
          -derivedDataPath build \
          build 2>&1 | tee build.log
      continue-on-error: true
    
    - name: Build for iOS Device (Release)
      run: |
        echo "Starting device archive build for Release configuration..."
        
        # Clean before building
        echo "Cleaning old build artifacts and Xcode cache..."
        rm -rf build/
        
        # Clean Xcode derived data to ensure fresh icon assets
        echo "Cleaning Xcode project..."
        xcodebuild clean \
          -project HebrewAlias.xcodeproj \
          -scheme HebrewAlias \
          -configuration Release
        
        # Build first (not archive) to ensure Swift compilation
        echo "Building for device..."
        xcodebuild \
          -project HebrewAlias.xcodeproj \
          -scheme HebrewAlias \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath build \
          build 2>&1 | tee -a build.log
        
        BUILD_EXIT=$?
        echo "Build command exit code: $BUILD_EXIT"
        
        if [ $BUILD_EXIT -ne 0 ]; then
          echo "❌ Build failed!"
          tail -100 build.log
          exit 1
        fi
        
        # Verify executable was created before archiving
        echo ""
        echo "=== Checking for compiled executable ==="
        BUILT_APP="build/Build/Products/Release-iphoneos/HebrewAlias.app"
        
        if [ ! -d "$BUILT_APP" ]; then
          echo "❌ ERROR: No app bundle found at: $BUILT_APP"
          echo ""
          echo "=== Searching for .app bundles in build directory ==="
          find build -type d -name "*.app" 2>/dev/null | head -10 || echo "No .app found"
          tail -100 build.log
          exit 1
        fi
        
        # Check if executable exists
        if [ ! -f "$BUILT_APP/HebrewAlias" ]; then
          echo "❌ ERROR: Executable not found in: $BUILT_APP"
          echo ""
          echo "=== Contents of app bundle ==="
          ls -la "$BUILT_APP/"
          echo ""
          echo "=== Build log errors ==="
          grep -i "error\|failed" build.log | head -20 || echo "No error patterns found"
          exit 1
        fi
        
        echo "✅ Executable found at: $BUILT_APP/HebrewAlias"
        echo "✅ Executable size: $(ls -lh $BUILT_APP/HebrewAlias | awk '{print $5}')"
        
        # Now archive
        echo "Archiving..."
        xcodebuild \
          -project HebrewAlias.xcodeproj \
          -scheme HebrewAlias \
          -configuration Release \
          -sdk iphoneos \
          -derivedDataPath build \
          archive -archivePath build/HebrewAlias.xcarchive 2>&1 | tee -a build.log
        
        ARCH_EXIT=$?
        echo "Archive command exit code: $ARCH_EXIT"
        
        # Check if archive actually has content
        if [ ! -d "build/HebrewAlias.xcarchive" ]; then
          echo "❌ ERROR: Archive directory not created!"
          echo "=== Last 100 lines of build.log ==="
          tail -100 build.log
          exit 1
        fi
        
        if [ ! -d "build/HebrewAlias.xcarchive/Products/Applications/HebrewAlias.app" ]; then
          echo "❌ ERROR: App not found in archive!"
          echo "Archive structure:"
          find build/HebrewAlias.xcarchive -type d
          echo ""
          echo "=== Last 100 lines of build.log ==="
          tail -100 build.log
          exit 1
        fi
        
        exit $ARCH_EXIT
    
    - name: Verify Device Build
      run: |
        echo "Checking for Release xcarchive..."
        if [ ! -d "build/HebrewAlias.xcarchive" ]; then
          echo "❌ ERROR: xcarchive not found!"
          echo ""
          echo "=== Searching for any .xcarchive in build directory ==="
          find build -type d -name "*.xcarchive" 2>/dev/null || echo "No .xcarchive found"
          echo ""
          echo "=== Build directory structure (first 50 lines) ==="
          find build -type f 2>/dev/null | head -50 || echo "Build directory empty or error listing"
          echo ""
          echo "=== Last 150 lines of build.log ==="
          tail -150 build.log 2>/dev/null || echo "No build.log found"
          exit 1
        fi
        echo "✅ xcarchive found!"
        
        # Show full xcarchive structure
        echo ""
        echo "=== xcarchive Structure ==="
        find build/HebrewAlias.xcarchive -type f | head -30
        
        # Look for the app bundle
        echo ""
        echo "=== Looking for app bundle ==="
        if [ -d "build/HebrewAlias.xcarchive/Products/Applications/HebrewAlias.app" ]; then
          echo "✅ App found in Products/Applications"
          ls -lh build/HebrewAlias.xcarchive/Products/Applications/HebrewAlias.app/
        else
          echo "❌ App not found in Products/Applications"
          echo "Searching for .app bundles in xcarchive..."
          find build/HebrewAlias.xcarchive -type d -name "*.app"
        fi
    
    - name: Create IPA for Sideloadly
      run: |
        echo "Creating IPA structure from xcarchive..."
        mkdir -p build/Payload
        
        # Extract app from xcarchive
        echo "Extracting app bundle from xcarchive..."
        cp -r build/HebrewAlias.xcarchive/Products/Applications/HebrewAlias.app build/Payload/
        
        # Verify the app was copied
        echo "=== Checking app contents ==="
        ls -la build/Payload/HebrewAlias.app/
        
        # Check if AppIcon files are included
        echo "=== Verifying AppIcon assets ==="
        if [ -d "build/Payload/HebrewAlias.app/Assets.car" ] || [ -f "build/Payload/HebrewAlias.app/Assets.car" ]; then
          echo "✅ Assets.car found in app bundle"
        else
          echo "⚠️ Assets.car not found - checking for icon files"
        fi
        
        if [ ! -f "build/Payload/HebrewAlias.app/HebrewAlias" ]; then
          echo ""
          echo "❌ ERROR: Executable not found in app bundle!"
          echo "This indicates the archive was created but the binary wasn't included"
          echo ""
          echo "=== FULL BUILD LOG ==="
          cat build.log
          echo ""
          echo "=== Archive structure ==="
          find build/HebrewAlias.xcarchive -type f | head -50
          exit 1
        fi
        
        echo "✅ App extracted successfully with executable"
        
        # Create IPA by zipping from the correct location
        echo "Creating ZIP archive..."
        cd build
        rm -f HebrewAlias.ipa
        zip -r HebrewAlias.ipa Payload/HebrewAlias.app
        
        # Verify IPA was created and has content
        if [ ! -f "HebrewAlias.ipa" ]; then
          echo "❌ ERROR: IPA file was not created!"
          exit 1
        fi
        
        ipa_size=$(stat -f%z HebrewAlias.ipa 2>/dev/null || stat -c%s HebrewAlias.ipa 2>/dev/null || echo "unknown")
        echo "IPA file size: $ipa_size bytes"
        if [ "$ipa_size" = "unknown" ] || [ "$ipa_size" -lt 5000000 ]; then
          echo "❌ WARNING: IPA file seems too small"
        fi
        
        ls -lh HebrewAlias.ipa
        echo "✅ IPA created successfully"
    
    - name: Upload Build Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pitkiot-build
        path: |
          build/HebrewAlias.ipa
          build.log
        retention-days: 30
    
    - name: Build Summary
      run: |
        echo "✅ Pitkiot Build Attempt Complete!"
        echo "Check artifacts for build logs"
